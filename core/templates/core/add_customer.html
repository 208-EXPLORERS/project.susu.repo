{% extends 'base.html' %}
{% load static %}
{% block title %}Add Customer - Susu System{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-user-plus"></i>
                        Add New Customer
                    </h4>
                </div>
                
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Personal Information -->
                            <div class="col-md-6">
                                <h5 class="text-secondary mb-3">
                                    <i class="fas fa-user"></i> Personal Information
                                </h5>
                                
                                <div class="form-group">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        Full Name <span class="text-danger">*</span>
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.name.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Enter the customer's full name</small>
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.phone.id_for_label }}" class="form-label">
                                        Phone Number
                                    </label>
                                    {{ form.phone }}
                                    {% if form.phone.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.phone.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Optional: Customer's phone number</small>
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.address.id_for_label }}" class="form-label">
                                        Address <span class="text-danger">*</span>
                                    </label>
                                    {{ form.address }}
                                    {% if form.address.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.address.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Customer's residential address</small>
                                </div>
                            </div>
                            
                            <!-- Additional Information -->
                            <div class="col-md-6">
                                <h5 class="text-secondary mb-3">
                                    <i class="fas fa-cog"></i> Additional Details
                                </h5>
                                
                                {% if form.customer_id %}
                                <div class="form-group">
                                    <label for="{{ form.customer_id.id_for_label }}" class="form-label">
                                        Customer ID
                                    </label>
                                    {{ form.customer_id }}
                                    {% if form.customer_id.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.customer_id.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Leave blank to auto-generate</small>
                                </div>
                                {% endif %}

                                {% if form.photo %}
                                <div class="form-group">
                                    <label for="{{ form.photo.id_for_label }}" class="form-label">
                                        Customer Photo
                                    </label>
                                    {{ form.photo }}
                                    {% if form.photo.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.photo.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Optional: Upload customer's photo</small>
                                    
                                    <!-- Photo Preview -->
                                    <div id="photo-preview" class="mt-2"></div>
                                </div>
                                {% endif %}

                                {% if form.status %}
                                <div class="form-group">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">
                                        Initial Status
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.status.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Customer's initial status</small>
                                </div>
                                {% endif %}

                                <!-- Customer ID Preview -->
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Customer ID Preview</h6>
                                    <p class="mb-0">Customer ID will be auto-generated based on address</p>
                                    <p class="mb-0"><strong>Format:</strong> <span id="id-preview">XX000</span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'officer_customers' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Cancel
                                    </a>
                                    
                                    <div>
                                        <button type="reset" class="btn btn-outline-warning mr-2">
                                            <i class="fas fa-undo"></i> Reset
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Add Customer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle text-info"></i>
                        Need Help?
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Required Fields</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Full Name</li>
                                <li><i class="fas fa-check text-success"></i> Address</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Optional Fields</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-info-circle text-info"></i> Phone Number</li>
                                <li><i class="fas fa-info-circle text-info"></i> Customer Photo</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-light mt-3">
                        <h6><i class="fas fa-lightbulb text-warning"></i> Tips</h6>
                        <ul class="mb-0">
                            <li>Customer ID is auto-generated using the first 2 letters of the address</li>
                            <li>Phone numbers help with customer communication</li>
                            <li>Photos make customer identification easier</li>
                            <li>All customers start with "Active" status by default</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-label {
    font-weight: 600;
    color: #495057;
}

.form-control {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.invalid-feedback {
    display: block;
    font-size: 0.875em;
    color: #dc3545;
}

.was-validated .form-control:valid {
    border-color: #28a745;
}

.was-validated .form-control:invalid {
    border-color: #dc3545;
}

#photo-preview img {
    max-width: 200px;
    max-height: 200px;
    border-radius: 0.375rem;
    border: 2px solid #dee2e6;
}

.alert-info {
    background-color: #e3f2fd;
    border-color: #2196f3;
    color: #0d47a1;
}

.text-danger {
    color: #dc3545 !important;
}

/* Animation for form validation */
.form-control.is-valid {
    animation: validField 0.3s ease-in-out;
}

.form-control.is-invalid {
    animation: invalidField 0.3s ease-in-out;
}

@keyframes validField {
    0% { border-color: #ced4da; }
    100% { border-color: #28a745; }
}

@keyframes invalidField {
    0% { border-color: #ced4da; }
    100% { border-color: #dc3545; }
}

/* Loading state for submit button */
.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.needs-validation');
    const nameInput = document.querySelector('#id_name');
    const addressInput = document.querySelector('#id_address');
    const photoInput = document.querySelector('#id_photo');
    const idPreview = document.getElementById('id-preview');
    const photoPreview = document.getElementById('photo-preview');

    // Real-time validation
    if (form) {
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                validateField(this);
            });
            
            input.addEventListener('input', function() {
                if (this.classList.contains('is-invalid')) {
                    validateField(this);
                }
            });
        });
    }

    // Customer ID preview
    function updateIdPreview() {
        if (addressInput && idPreview) {
            const address = addressInput.value.trim();
            if (address.length >= 2) {
                const prefix = address.substring(0, 2).toUpperCase();
                // You might want to make an AJAX call here to get the actual next number
                idPreview.textContent = prefix + '000';
            } else {
                idPreview.textContent = 'XX000';
            }
        }
    }

    if (addressInput) {
        addressInput.addEventListener('input', updateIdPreview);
        updateIdPreview(); // Initial call
    }

    // Photo preview
    if (photoInput && photoPreview) {
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                // Check file size (optional - limit to 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size too large. Please select an image smaller than 5MB.');
                    this.value = '';
                    photoPreview.innerHTML = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.innerHTML = `
                        <img src="${e.target.result}" class="img-thumbnail" alt="Customer Photo Preview">
                        <div class="mt-2">
                            <small class="text-muted">File: ${file.name} (${(file.size / 1024).toFixed(1)} KB)</small>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else if (file) {
                alert('Please select a valid image file.');
                this.value = '';
                photoPreview.innerHTML = '';
            } else {
                photoPreview.innerHTML = '';
            }
        });
    }

    // Form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();

            if (validateForm()) {
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                // Show loading state
                submitBtn.classList.add('btn-loading');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
                submitBtn.disabled = true;

                // Submit form after short delay to show loading state
                setTimeout(() => {
                    // Re-enable form submission
                    const actualForm = document.createElement('form');
                    actualForm.method = form.method;
                    actualForm.action = form.action;
                    actualForm.enctype = form.enctype;
                    
                    // Copy all form data
                    const formData = new FormData(form);
                    for (let [key, value] of formData.entries()) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value;
                        actualForm.appendChild(input);
                    }
                    
                    document.body.appendChild(actualForm);
                    actualForm.submit();
                }, 500);
            } else {
                // Scroll to first invalid field
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
            }

            form.classList.add('was-validated');
        });
    }

    // Reset button functionality
    const resetBtn = form.querySelector('button[type="reset"]');
    if (resetBtn) {
        resetBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (confirm('Are you sure you want to reset all fields? This action cannot be undone.')) {
                // Reset form
                form.reset();
                
                // Clear validation classes
                const inputs = form.querySelectorAll('.is-valid, .is-invalid');
                inputs.forEach(input => {
                    input.classList.remove('is-valid', 'is-invalid');
                });
                
                // Clear photo preview
                if (photoPreview) {
                    photoPreview.innerHTML = '';
                }
                
                // Reset ID preview
                if (idPreview) {
                    idPreview.textContent = 'XX000';
                }
                
                // Remove was-validated class
                form.classList.remove('was-validated');
                
                // Focus on first input
                const firstInput = form.querySelector('input:not([type="hidden"])');
                if (firstInput) {
                    firstInput.focus();
                }
            }
        });
    }

    // Validation functions
    function validateField(field) {
        let isValid = field.checkValidity();
        
        // Custom validation for specific fields
        if (field.type === 'tel' || field.name === 'phone') {
            // Phone validation (optional field)
            if (field.value.trim() !== '') {
                const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
                if (!phoneRegex.test(field.value.trim())) {
                    field.setCustomValidity('Please enter a valid phone number');
                    isValid = false;
                } else {
                    field.setCustomValidity('');
                }
            } else {
                field.setCustomValidity('');
            }
        }
        
        // Name validation
        if (field.name === 'name') {
            const name = field.value.trim();
            if (name.length < 2) {
                field.setCustomValidity('Name must be at least 2 characters long');
                isValid = false;
            } else if (!/^[a-zA-Z\s\-'\.]+$/.test(name)) {
                field.setCustomValidity('Name can only contain letters, spaces, hyphens, apostrophes, and periods');
                isValid = false;
            } else {
                field.setCustomValidity('');
            }
        }
        
        // Address validation
        if (field.name === 'address') {
            const address = field.value.trim();
            if (address.length < 5) {
                field.setCustomValidity('Address must be at least 5 characters long');
                isValid = false;
            } else {
                field.setCustomValidity('');
            }
        }
        
        field.classList.remove('is-valid', 'is-invalid');
        field.classList.add(isValid ? 'is-valid' : 'is-invalid');
        
        return isValid;
    }

    function validateForm() {
        let isValid = true;
        const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
        
        inputs.forEach(input => {
            if (!validateField(input)) {
                isValid = false;
            }
        });
        
        // Additional form-level validation
        const allInputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
        allInputs.forEach(input => {
            if (!input.hasAttribute('required') && input.value.trim() !== '') {
                // Validate optional fields if they have values
                if (!validateField(input)) {
                    isValid = false;
                }
            }
        });
        
        return isValid;
    }

    // Auto-save draft functionality (optional)
    function saveDraft() {
        const formData = new FormData(form);
        const draftData = {};
        
        for (let [key, value] of formData.entries()) {
            if (key !== 'csrfmiddlewaretoken' && key !== 'photo') {
                draftData[key] = value;
            }
        }
        
        localStorage.setItem('customer_form_draft', JSON.stringify(draftData));
    }

    function loadDraft() {
        const draftData = localStorage.getItem('customer_form_draft');
        if (draftData) {
            try {
                const data = JSON.parse(draftData);
                Object.keys(data).forEach(key => {
                    const field = form.querySelector(`[name="${key}"]`);
                    if (field && data[key]) {
                        field.value = data[key];
                    }
                });
                updateIdPreview();
            } catch (e) {
                console.log('Could not load draft data');
            }
        }
    }

    // Auto-save every 30 seconds
    if (form) {
        setInterval(saveDraft, 30000);
        
        // Load draft on page load
        loadDraft();
        
        // Clear draft on successful submission
        form.addEventListener('submit', function() {
            localStorage.removeItem('customer_form_draft');
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + S to save (submit form)
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            if (form) {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.click();
                }
            }
        }
        
        // Ctrl/Cmd + R to reset (with confirmation)
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
            e.preventDefault();
            const resetBtn = form.querySelector('button[type="reset"]');
            if (resetBtn) {
                resetBtn.click();
            }
        }
    });

    // Initialize tooltips if Bootstrap is available
    if (typeof bootstrap !== 'undefined') {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});
</script>
{% endblock %}