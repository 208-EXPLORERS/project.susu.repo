{% extends 'base.html' %}
{% load static %}

{% block title %}{{ customer.name }} - Customer Details{% endblock %}

{% block extra_head %}
<style>
    .customer-photo {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border: 3px solid #007bff;
    }
    
    .customer-header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .contribution-item {
        transition: background-color 0.2s ease;
    }
    
    .contribution-item:hover {
        background-color: #f8f9fa;
    }
    
    .status-badge {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
    
    .timeline-item {
        position: relative;
        padding-left: 2rem;
        padding-bottom: 1rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0.5rem;
        width: 0.75rem;
        height: 0.75rem;
        background: #007bff;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 2px #007bff;
    }
    
    .timeline-item::after {
        content: '';
        position: absolute;
        left: 0.8125rem;
        top: 1.25rem;
        width: 2px;
        height: calc(100% - 1rem);
        background: #e9ecef;
    }
    
    .timeline-item:last-child::after {
        display: none;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    @media (max-width: 768px) {
        .customer-photo {
            width: 80px;
            height: 80px;
        }
        
        .stat-card {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Customer Header -->
    <div class="customer-header p-4">
        <div class="row align-items-center">
            <div class="col-auto">
                {% if customer.photo %}
                    <img src="{{ customer.photo.url }}" alt="{{ customer.name }}" class="customer-photo rounded-circle">
                {% else %}
                    <div class="customer-photo rounded-circle bg-light d-flex align-items-center justify-content-center">
                        <i class="fas fa-user fa-3x text-muted"></i>
                    </div>
                {% endif %}
            </div>
            <div class="col">
                <h1 class="mb-2">{{ customer.name }}</h1>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><i class="fas fa-id-card"></i> <strong>ID:</strong> {{ customer.customer_id }}</p>
                        <p class="mb-1"><i class="fas fa-phone"></i> <strong>Phone:</strong> {{ customer.phone|default:"Not provided" }}</p>
                        <p class="mb-0"><i class="fas fa-map-marker-alt"></i> <strong>Address:</strong> {{ customer.address }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><i class="fas fa-calendar-alt"></i> <strong>Joined:</strong> {{ customer.date_joined|date:"M d, Y" }}</p>
                        <p class="mb-1"><i class="fas fa-user-tie"></i> <strong>Officer:</strong> {{ customer.officer.user.get_full_name|default:customer.officer.user.username }}</p>
                        <p class="mb-0">
                            <i class="fas fa-info-circle"></i> <strong>Status:</strong>
                            <span class="badge status-badge {% if customer.status == 'active' %}badge-success{% else %}badge-warning{% endif %}">
                                {{ customer.get_status_display }}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <div class="dropdown">
                    <button class="btn btn-light dropdown-toggle" type="button" id="customerActions" data-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i> Actions
                    </button>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#editCustomerModal">
                            <i class="fas fa-edit"></i> Edit Customer
                        </a>
                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#addContributionModal">
                            <i class="fas fa-plus"></i> Add Contribution
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="#" onclick="return confirm('Are you sure?')">
                            <i class="fas fa-trash"></i> Delete Customer
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card p-3">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-success text-white me-3">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="mb-0" data-stat-type="total_savings">â‚µ{{ total_savings|floatformat:2 }}</h3>
                        <small class="text-muted">Total Savings</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card p-3">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-info text-white me-3">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="mb-0" data-stat-type="contribution_count">{{ contributions.count }}</h3>
                        <small class="text-muted">Total Contributions</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card p-3">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-warning text-white me-3">
                        <i class="fas fa-handshake"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="mb-0" data-stat-type="loan_count">{{ loans.count }}</h3>
                        <small class="text-muted">Total Loans</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card p-3">
                <div class="d-flex align-items-center">
                    <div class="stat-icon {% if customer.days_since_last_contribution <= 7 %} bg-success{% else %}bg-danger{% endif %} text-white me-3">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="mb-0">
                            {% if customer.last_contribution_date %}
                                {{ customer.days_since_last_contribution|default:0 }}
                            {% else %}
                                N/A
                            {% endif %}
                        </h3>
                        <small class="text-muted">Days Since Last</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="customerTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="contributions-tab" data-toggle="tab" href="#contributions" role="tab">
                                <i class="fas fa-coins"></i> Contributions
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="loans-tab" data-toggle="tab" href="#loans" role="tab">
                                <i class="fas fa-handshake"></i> Loans
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="activity-tab" data-toggle="tab" href="#activity" role="tab">
                                <i class="fas fa-history"></i> Activity Timeline
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="customerTabsContent">
                        <!-- Contributions Tab -->
                        <div class="tab-pane fade show active" id="contributions" role="tabpanel">
                            {% if contributions %}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">Contribution History</h5>
                                    <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addContributionModal">
                                        <i class="fas fa-plus"></i> Add Contribution
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Running Total</th>
                                                <th>Notes</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for contribution in contributions %}
                                            <tr class="contribution-item">
                                                <td>
                                                    <strong>{{ contribution.date|date:"M d, Y" }}</strong>
                                                    <br><small class="text-muted">{{ contribution.date|date:"g:i A" }}</small>
                                                </td>
                                                <td>
                                                    <span class="badge badge-success">â‚µ{{ contribution.amount|floatformat:2 }}</span>
                                                </td>
                                                <td>
                                                    {% comment %} This would need to be calculated in the view or model {% endcomment %}
                                                    <span class="text-muted">â‚µ{{ contribution.running_total|default:"--"|floatformat:2 }}</span>
                                                </td>
                                                <td>
                                                    {{ contribution.notes|default:"--"|truncatechars:50 }}
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger" title="Delete" onclick="return confirm('Delete this contribution?')">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-coins"></i>
                                    <h4>No Contributions Yet</h4>
                                    <p>This customer hasn't made any contributions yet.</p>
                                    <button class="btn btn-primary" data-toggle="modal" data-target="#addContributionModal">
                                        <i class="fas fa-plus"></i> Add First Contribution
                                    </button>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Loans Tab -->
                        <div class="tab-pane fade" id="loans" role="tabpanel">
                            {% if loans %}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">Loan History</h5>
                                    <a href="{% url 'apply_loan' customer.id %}" class="btn btn-warning btn-sm">
                                        <i class="fas fa-plus"></i> New Loan Application
                                    </a>
                                </div>
                                <div class="row">
                                    {% for loan in loans %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card" data-loan-id="{{ loan.id }}" data-current-status="{{ loan.status }}">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <strong>Loan #{{ loan.id }}</strong>
                                                <span class="loan-status-badge badge {% if loan.status == 'approved' %}badge-success{% elif loan.status == 'pending' %}badge-warning{% elif loan.status == 'rejected' %}badge-danger{% else %}badge-secondary{% endif %}">
                                                    {{ loan.get_status_display }}
                                                </span>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <small class="text-muted">Amount</small>
                                                        <p class="mb-2"><strong>â‚µ{{ loan.amount|floatformat:2 }}</strong></p>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted">Applied</small>
                                                        <p class="mb-2">{{ loan.date_applied|date:"M d, Y" }}</p>
                                                    </div>
                                                </div>
                                                {% if loan.purpose %}
                                                <div class="mb-2">
                                                    <small class="text-muted">Purpose</small>
                                                    <p class="mb-0">{{ loan.purpose|truncatechars:100 }}</p>
                                                </div>
                                                {% endif %}
                                                <div class="approval-info">
                                                    {% if loan.status == 'approved' and loan.date_approved %}
                                                        <small class="text-success">
                                                            <i class="fas fa-check-circle"></i>
                                                            Approved on {{ loan.date_approved|date:"M d, Y" }}
                                                        </small>
                                                    {% elif loan.status == 'rejected' and loan.rejection_reason %}
                                                        <small class="text-danger">
                                                            <i class="fas fa-times-circle"></i>
                                                            Rejected: {{ loan.rejection_reason }}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                                <div class="last-updated mt-2">
                                                    <small class="text-muted">
                                                        <i class="fas fa-sync-alt"></i> 
                                                        Last updated: <span>{{ loan.updated_at|date:"M d, Y g:i A"|default:"N/A" }}</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-handshake"></i>
                                    <h4>No Loans Yet</h4>
                                    <p>This customer hasn't applied for any loans yet.</p>
                                    <a href="{% url 'apply_loan' customer.id %}" class="btn btn-warning">
                                        <i class="fas fa-plus"></i> Create Loan Application
                                    </a>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Activity Timeline Tab -->
                        <div class="tab-pane fade" id="activity" role="tabpanel">
                            <h5 class="mb-3">Activity Timeline</h5>
                            <div class="timeline">
                                <!-- Customer Registration -->
                                <div class="timeline-item">
                                    <div class="card">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <strong><i class="fas fa-user-plus text-success"></i> Customer Registered</strong>
                                                    <p class="mb-0 text-muted">{{ customer.name }} joined the system</p>
                                                </div>
                                                <small class="text-muted">{{ customer.date_joined|date:"M d, Y" }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Contributions -->
                                {% for contribution in contributions|slice:":5" %}
                                <div class="timeline-item">
                                    <div class="card">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <strong><i class="fas fa-coins text-success"></i> Contribution Made</strong>
                                                    <p class="mb-0 text-muted">â‚µ{{ contribution.amount|floatformat:2 }} contributed</p>
                                                </div>
                                                <small class="text-muted">{{ contribution.date|date:"M d, Y" }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Recent Loans -->
                                {% for loan in loans|slice:":3" %}
                                <div class="timeline-item">
                                    <div class="card">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <strong>
                                                        <i class="fas fa-handshake {% if loan.status == 'approved' %}text-success{% elif loan.status == 'rejected' %}text-danger{% else %}text-warning{% endif %}"></i> 
                                                        Loan {{ loan.get_status_display }}
                                                    </strong>
                                                    <p class="mb-0 text-muted">â‚µ{{ loan.amount|floatformat:2 }} loan application</p>
                                                </div>
                                                <small class="text-muted">{{ loan.date_applied|date:"M d, Y" }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                {% if not contributions and not loans %}
                                <div class="empty-state">
                                    <i class="fas fa-history"></i>
                                    <h4>No Activity Yet</h4>
                                    <p>Customer activity will appear here as they interact with the system.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Contribution Modal -->
<div class="modal fade" id="addContributionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Contribution</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'add_contribution' customer.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="amount">Amount (â‚µ)</label>
                        <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Contribution</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editCustomerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Customer</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'edit_customer' customer.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_name">Name</label>
                                <input type="text" class="form-control" id="edit_name" name="name" value="{{ customer.name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_phone">Phone</label>
                                <input type="tel" class="form-control" id="edit_phone" name="phone" value="{{ customer.phone }}">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit_address">Address</label>
                        <input type="text" class="form-control" id="edit_address" name="address" value="{{ customer.address }}" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_status">Status</label>
                                <select class="form-control" id="edit_status" name="status">
                                    <option value="active" {% if customer.status == 'active' %}selected{% endif %}>Active</option>
                                    <option value="inactive" {% if customer.status == 'inactive' %}selected{% endif %}>Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_photo">Photo</label>
                                <input type="file" class="form-control-file" id="edit_photo" name="photo" accept="image/*">
                                {% if customer.photo %}
                                    <small class="text-muted">Current photo will be replaced</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize tooltips
    $('[title]').tooltip();
    
    // Auto-refresh customer stats every 30 seconds
    setInterval(function() {
        // This would need an API endpoint to get updated customer stats
        // updateCustomerStats();
    }, 30000);
    
    // Handle tab switching with URL hash
    if (window.location.hash) {
        $('.nav-tabs a[href="' + window.location.hash + '"]').tab('show');
    }
    
    $('.nav-tabs a').on('shown.bs.tab', function (e) {
        window.location.hash = e.target.hash;
    });
    
    // Enhanced form validation
    $('.needs-validation').on('submit', function(e) {
        if (!this.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        $(this).addClass('was-validated');
    });
    
    // Real-time form validation for modals
    $('#addContributionModal input, #editCustomerModal input').on('blur', function() {
        if (!this.checkValidity()) {
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid').addClass('is-valid');
        }
    });
    
    // Photo preview for edit customer modal
    $('#edit_photo').on('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Create or update preview
                let preview = $('#photo-preview');
                if (preview.length === 0) {
                    $('#edit_photo').after('<div id="photo-preview" class="mt-2"></div>');
                    preview = $('#photo-preview');
                }
                preview.html('<img src="' + e.target.result + '" class="img-thumbnail" style="max-width: 100px;">');
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Print customer details
    window.printCustomer = function() {
        window.print();
    };
    
    // Export customer data (placeholder)
    window.exportCustomer = function() {
        alert('Export functionality would be implemented here');
    };
});

// Custom event listener for loan status changes
document.addEventListener('loanStatusChanged', function(e) {
    const { loanData, previousStatus } = e.detail;
    console.log(`Customer {{ customer.id }} loan status changed: ${previousStatus} â†’ ${loanData.status}`);
    
    // You could update customer stats here if needed
    // updateCustomerStats();
});
</script>
{% endblock %}